# AndroidCodeShrink
A bytecode plugin to shrink apk size.
一个字节码插装工具，用于在编译期间删除无用代码，缩减apk体积。

### 背景

食堂吃饭的时候收到公众号字节跳动技术团队的推送，打开看到是一篇关于apk体积优化的技术博文,[抖音Android包体积优化探索：从Class字节码入手精简DEX体积]( https://mp.weixin.qq.com/s/npT9MW4TQWH--fKsC_3NCQ )。
这篇博文详细的阐述了从Class字节码精简dex体积的各种方案，例如去除冗余赋值，短方法内联，删除无用代码等。
去除冗余赋值的方案字节团队已经开源，而短方法内联等手段现在R8上也已经实现了，所以不用浪费太多精力在这两个方案上。
关于删除无用代码的方案，当时字节团队尚未开源，但是在博文中已经提供了解题思路，我只需要按照其思路实现即可。
于是我从繁忙的工作间歇中抽出时间一顿操作，终于在北京时间2022年3月18日晚上十一点多完成了基本功能并提交到github开源。回家路上看到京城难得的三月雪，内心掩饰不住的小激动，忍不住更新了一波盆友圈。
第二条早上被工作电话惊醒，等把工作忙活玩，我登上g站，准备完善一下我第一开源项目的readme,主要想表达对优秀的技术团队byteX的敬意，毕竟是大佬们提供的思路。
于是我又跑到byteX项目下逛了一圈，结果我发现。。。。删除无用代码的方案，已经开源了！已经开源了！已经开源了！
哎，沮丧，伤心，想哭。。。。
懊恼了大概十分钟，我慢慢平静下来。虽然我这个项目的实用价值瞬间归零，但是学习价值大大的呀。
我这份代码比字节的那个简单易懂，很容易就捋清楚gradle插件的编写以及transform的方法还有字节码处理的过程，完全可以当做一个学习教程来使用。
而且对我本人来讲，做这个项目的过程本身就是一个很有意义的事情，又积累到了许多探索技术的经验。
回顾整个项目过程，我首先是对那边技术博文提供的方案进行了辩证的学习。博文的编写时间往往和发布时间是有时间差的，所以里面提到的技术不一定是最新的，我需要辩证的学习，比如我发现博文里面没有提及D8和R8编译器，所以我调研了最新的R8编译器提供的代码优化项，发现方法内联等操作已经支持了，于是我就没有深入博文中关于方法内联的内容。
要调研和验证R8是否提供这些优化项，就必须先熟悉字节码，要掌握java代码和其字节码的对应关系。所以我一定要有一个方法可以快速查看某个java文件对应的class文件的工具，如果都使用javap -c指令，那就太费时间了。于是我找到了jclasslib这个插件，大大提高了我的学习效率。
至于如何学习各个字节码指令，那就是官方文档优先，我找到了oracle的jvm规范文档。
为了学习编写gradle插件，我先对gradle的基础知识做了复习，避免因为基本思路上的错误导致研发受阻，不怕代码有bug不可怕，思路是错的才可怕。
同样是为了在调研过程中避免中间变量的干扰，我选择通过把插件发布到本地maven的方式进行集成，这样出了问题好定位，如果直接发布到远端maven，定位问题的时候复杂度大大增加。

总之，这个项目，没白干。

### 基本思路

大致思想就是利用transform干涉编译过程，通过ASM库找到目标代码生成的字节码集，并将其全部删除。
可以根据目标方法的特征先找到生成的最后一条字节码指令，然后根据jvm执行引擎的原理“一个方法执行后，操作数栈应该和执行前一样”，
先自己创建一个栈，从后往前遍历字节码指令，根据字节码第操作数栈的操作，在我们自己的栈上做逆操作，直到栈空，则找到了第一条指令。
最后，从第一条一直删到最后一条。

这需要对两百多种字节码做处理。目前本工具已经完成了20多种字节码的处理，本工具执行过程中，如果遇到还没有支持的字节码，就直接跳过不处理，不影响正常编译。
目前这20多种字节码基本已经足够应对项目中的大部分日志语句了，本工具应用到公司项目中的把log.v全部删除，大约节省了5k的空间。

对于其余没有处理的字节码，就得靠大家了~只要把所有字节码的处理逻辑完成，理论上就可以删除任意代码。

处理字节码的程序位于OpStackProcessor.java，大家只需要在这个文件中增加对字节码的处理逻辑即可。
可以在oracle的文档上查看各个字节码的规范，例如 https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.aload_n
还可以在android studio上安装jclasslib这个插件，可以很方便的查看某个java文件生成的class文件，并且点击指令可以自动打开浏览器跳转到oracle文档页面。

### 项目结构




**delete-method-plugin**

负责遍历读取工程和Android SDK里的所有class文件，删除指定的方法调用语句，并回写到transform指定目录。

**app**

测试用于测试插件功能，在此模块中引用delete-method-plugin，从而删除指定代码。

## 鸣谢

- [ByteX](https://github.com/bytedance/ByteX) 

