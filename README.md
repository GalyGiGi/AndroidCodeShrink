# AndroidCodeShrink
A bytecode plugin to shrink apk size.

一个字节码插装工具，用于在编译期间删除无用代码，缩减apk体积。
idea来自于字节团队的一篇技术[博文]( https://mp.weixin.qq.com/s/npT9MW4TQWH--fKsC_3NCQ )

上述博文详细的阐述了从Class字节码精简dex体积的各种方案，例如去除冗余赋值，短方法内联，删除无用代码等。
去除冗余赋值的方案字节团队已经开源，而短方法内联等手段现在R8上也已经实现了，所以不用浪费太多精力在这两个方案上。
关于删除无用代码的方案，字节团队尚未开源，但是在博文中已经提供了解题思路，我们只需要按照其思路实现即可。（额，刚发现已经开源了。。。哎。。。白忙活）

大致思想就是利用transform干涉编译过程，通过ASM库找到目标代码生成的字节码集，并将其全部删除。
可以根据目标方法的特征先找到生成的最后一条字节码指令，然后根据jvm执行引擎的原理“一个方法执行后，操作数栈应该和执行前一样”，
先自己创建一个栈，从后往前遍历字节码指令，根据字节码第操作数栈的操作，在我们自己的栈上做逆操作，直到栈空，则找到了第一条指令。
最后，从第一条一直删到最后一条。

这需要对两百多种字节码做处理。目前本工具已经完成了20多种字节码的处理，本工具执行过程中，如果遇到还没有支持的字节码，就直接跳过不处理，不影响正常编译。
目前这20多种字节码基本已经足够应对项目中的大部分日志语句了，本工具应用到公司项目中的把log.v全部删除，大约节省了5k的空间。

对于其余没有处理的字节码，就得靠大家了~只要把所有字节码的处理逻辑完成，理论上就可以删除任意代码。

处理字节码的程序位于OpStackProcessor.java，大家只需要在这个文件中增加对字节码的处理逻辑即可。
可以在oracle的文档上查看各个字节码的规范，例如 https://docs.oracle.com/javase/specs/jvms/se16/html/jvms-6.html#jvms-6.5.aload_n
还可以在android studio上安装jclasslib这个插件，可以很方便的查看某个java文件生成的class文件，并且点击指令可以自动打开浏览器跳转到oracle文档页面。

### 项目结构




**delete-method-plugin**

负责遍历读取工程和Android SDK里的所有class文件，删除指定的方法调用语句，并回写到transform指定目录。

**app**

测试用于测试插件功能，在此模块中引用delete-method-plugin，从而删除指定代码。

## 鸣谢

- [ByteX](https://github.com/bytedance/ByteX) 

